<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RISC-V VHDL: System-on-Chip: SW Debugger API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="fixed_styles.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RISC-V VHDL: System-on-Chip
   &#160;<span id="projectnumber">2.0</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('sw_debugger_api_link.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">SW Debugger API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section user"><dt>Overview</dt><dd>This debugger was specially developed as a software utility to interact with our SOC implementation in <code>riscv_soc</code> repository. The main purpose was to provide convinient way to develop and debug our Satellite Navigation firmware that can not be debugged by any other tool provided RISC-V community. Additionally, we would like to use the single unified application capable to work with Real and Simulated platforms without any modification of source code. Debugger provides base functionality such as: run control, read/write memory, registers and CSRs, breakpoints. It allows to reload FW image and reset target. Also we are developing own version of the CPU simulator (analog of <code>spike</code>) that can be extended with peripheries models to Full SOC simulator. These extensions for the debugger simplify porting procedure of the Operating System (Zephyr project) so that simulation doesn't require any hardware and allow develop SW simultaneously with HW developing.</dd></dl>
<h1><a class="anchor" id="dbg_1"></a>
C++ Project structure</h1>
<p>General idea of the project is to develop one <code>Core</code> library providing API methods for registering <code>classes</code>, <code>services</code>, <code>attributes</code> and methods to interact with them. Each extension plugin registers one or several class services performing some usefull work. All plugins are built as an independent libraries that are opening by <code>Core</code> library at initialization stage with the call of method <b>plugin_init()</b>. All Core API methods start with <code>RISCV_</code>... prefix: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> RISCV_register_class(IFace *icls);</div><div class="line"></div><div class="line">IFace *RISCV_create_service(IFace *iclass, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, </div><div class="line">                            AttributeType *args);</div><div class="line"></div><div class="line">IFace *RISCV_get_service(<span class="keyword">const</span> <span class="keywordtype">char</span> *name);</div><div class="line">...</div></div><!-- fragment --><p>Configuration of the debugger and plugins is fully described in JSON formatted configuration files <b>targets/target_name.json</b>. These files store all instantiated services names, attributes values and interconnect among plugins. This configuration can be saved to/load from file at any time. By default command <code>exit</code> will save current debugger state into file (including full command history).</p>
<dl class="section note"><dt>Note</dt><dd>You can manually add/change new Registers/CSRs names and indexes by modifying this config file without changing source code.</dd></dl>
<dl class="section user"><dt>Folders description</dt><dd><ol type="1">
<li><b>libdgb64g</b> - Core library (so/dll) that provides standard API methods defined in file <code><a class="el" href="api__core_8h_source.html" title="Core API methods declaration. ">api_core.h</a></code>.</li>
<li><b>appdbg64g</b> - Executable (exe) file implements functionality of the console debugger.</li>
<li><em>Plugins:</em> <ol type="a">
<li><b>simple_plugin</b> - Simple plugin (so/dll library) just for demonstration of the integration with debugger.</li>
<li><b>cpu_fnc_plugin</b> - Functional model of the RISC-V CPU (so/dll library).</li>
<li><b>cpu_sysc_plugin</b> - Precise SystemC model of RIVER CPU (so/dll library).</li>
<li><b>socsim_plugin</b> - Functional models of the peripheries and assembled board (so/dll library). This plugin registers several classes: <code>UART</code>, <code>GPIO</code>, <code>SRAM</code>, <code>ROMs</code> and etc.</li>
</ol>
</li>
</ol>
</dd></dl>
<h1><a class="anchor" id="dbg_target"></a>
Debug Target</h1>
<p>We provide several targets that can run your software (bootloader, firmware or user application) without source code modifications:</p>
<table class="doxtable">
<tr>
<th>Start Configuration </th><th>Description  </th></tr>
<tr>
<td>$ ./_run_functional_sim.sh[bat]</td><td>Functional RISC-V Full System Model </td></tr>
<tr>
<td>$ ./_run_systemc_sim.sh[bat] </td><td>Use SystemC Precise Model of RIVER CPU </td></tr>
<tr>
<td>$ ./_run_fpga_gui.sh[bat] </td><td>FPGA board. Default port 'COM3', TAP IP = 192.168.0.51 </td></tr>
</table>
<p>To run debugger with real FPGA target connected via Ethernet do: </p><pre class="fragment">*     # cd rocket_soc/debugger/win32build/debug
*     # _run_functional_sim.bat
* </pre><p>The result should look like on the picture below:</p>
<div class="image">
<img src="pics/dbg_fpga_gui1.png" alt="debugger FPGA+GUI"/>
</div>
 <h2><a class="anchor" id="sw_debug_ss1"></a>
Plugins interaction structure</h2>
<p>Core library uses UDP protocol to communicate with all targets: FPGA or simulators. The general structure is looking like on the following figure:</p>
<div class="image">
<img src="pics/dbg_sim.png" alt="sim debug"/>
</div>
 <p>or with real Hardware</p>
<div class="image">
<img src="pics/dbg_fpga.png" alt="fpga debug"/>
</div>
 <h1><a class="anchor" id="sw_debug_troubles"></a>
Troubleshooting</h1>
<h2><a class="anchor" id="sw_problem_1"></a>
Image Files not found</h2>
<p>If you'll get the error messages that image files not found</p>
<div class="image">
<img src="pics/dbg_err1.png" alt="File not found"/>
</div>
 <p>To fix this problem do the following steps:</p><ol type="1">
<li>Close debugger console using <code>exit</code> command.</li>
<li>Open <em>config_file_name.json</em> file in any editor.</li>
<li>Find strings that specify these paths and correct them. Simulator uses the same images as VHDL platform for ROMs intialization. You can find them in <em>'rocket_soc/fw_images'</em> directory. After that you should see something like follow:</li>
</ol>
<div class="image">
<img src="pics/dbg_simout1.png" alt="Simulator output"/>
</div>
 <p>Debug your target. All commands that are available for Real Hardware absolutely valid for the Simulation. Debugger doesn't see any difference between these two targets.</p>
<dl class="section note"><dt>Note</dt><dd>We redirect all output streams of the simulated platform into debugger console but we are going to implement independent GUI for simulated platform with its own UART/GPIO or Ethernet outputs and serial console window.</dd></dl>
<h2><a class="anchor" id="sw_problem_2"></a>
Can't open COM3 when FPGA is used</h2>
<ol type="1">
<li>Open <em>fpga_gui.json</em></li>
<li>Change value <b>['ComPortName','COM3'],</b> on your one (for an example on <code>ttyUSB0</code>).</li>
</ol>
<h2><a class="anchor" id="sw_problem_3"></a>
EDCL: No response. Break read transaction</h2>
<p>This erros means that host cannot locate board with specified IP address. Before you continue pass through the following checklist:</p><ol type="1">
<li>You should properly <a class="el" href="">setup network connection </a> and see FPGA board in ARP-table.</li>
<li>If you've changed default FPGA IP address:<ol type="a">
<li>Open <em>fpga_gui.json</em></li>
<li>Change value <b>['BoardIP','192.168.0.51']</b> on your one.</li>
</ol>
</li>
<li>Run debugger</li>
</ol>
<p>Example of debugging session (Switch ON all User LEDs on board): </p><div class="fragment"><div class="line">riscv# help                     -- Print full list of commands</div><div class="line">riscv# csr MCPUID               -- Read supported ISA extensions</div><div class="line">riscv# read 0xfffff000 20       -- Read 20 bytes from PNP module</div><div class="line">riscv# write 0x80000000 4 0xff  -- Write into GPIO <span class="keyword">new</span> LED value</div><div class="line">riscv# loadelf helloworld       -- Load elf-file to board RAM and run</div></div><!-- fragment --><p>Debugger console view</p>
<div class="image">
<img src="pics/dbg_testhw.png" alt="HW debug example"/>
</div>
  </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
